name: Release Windows Installer

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  id-token: write

jobs:
  build-and-release:
    runs-on: windows-latest
    environment: release

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binary
        run: cargo build --release

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Sign app binary (Artifact Signing)
        uses: azure/artifact-signing-action@v1
        with:
          endpoint: ${{ secrets.TRUSTED_SIGNING_ENDPOINT }}
          signing-account-name: ${{ secrets.TRUSTED_SIGNING_ACCOUNT }}
          certificate-profile-name: ${{ secrets.TRUSTED_SIGNING_CERT_PROFILE }}
          files-folder: ${{ github.workspace }}\target\release
          files-folder-filter: mangochat.exe
          file-digest: SHA256
          timestamp-rfc3161: http://timestamp.acs.microsoft.com
          timestamp-digest: SHA256

      - name: Install Inno Setup
        run: choco install innosetup --no-progress -y

      - name: Determine app version
        id: vars
        shell: pwsh
        run: |
          $cargoToml = Get-Content "Cargo.toml" -Raw
          $m = [regex]::Match($cargoToml, '(?m)^version\s*=\s*"([^"]+)"')
          if (-not $m.Success) { throw "Could not parse version from Cargo.toml" }
          $version = $m.Groups[1].Value
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Build installer
        shell: pwsh
        run: |
          $iscc = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
          if (-not (Test-Path $iscc)) { throw "ISCC not found: $iscc" }
          $exe = (Resolve-Path "target\release\mangochat.exe").Path
          & $iscc "installer\MangoChat.iss" "/DMyAppVersion=${{ steps.vars.outputs.version }}" "/DMyAppExe=$exe"

      - name: Sign installer (Artifact Signing)
        uses: azure/artifact-signing-action@v1
        with:
          endpoint: ${{ secrets.TRUSTED_SIGNING_ENDPOINT }}
          signing-account-name: ${{ secrets.TRUSTED_SIGNING_ACCOUNT }}
          certificate-profile-name: ${{ secrets.TRUSTED_SIGNING_CERT_PROFILE }}
          files-folder: ${{ github.workspace }}\dist
          files-folder-filter: MangoChat-Setup-*.exe
          file-digest: SHA256
          timestamp-rfc3161: http://timestamp.acs.microsoft.com
          timestamp-digest: SHA256

      - name: Generate checksums
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $files = Get-ChildItem dist -File
          if (-not $files) { throw "No files found in dist/" }
          $out = "dist\SHA256SUMS.txt"
          if (Test-Path $out) { Remove-Item $out -Force }
          foreach ($f in $files) {
            $h = Get-FileHash $f.FullName -Algorithm SHA256
            "$($h.Hash)  $($f.Name)" | Out-File -FilePath $out -Encoding utf8 -Append
          }

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.exe
            dist/SHA256SUMS.txt
          generate_release_notes: true

